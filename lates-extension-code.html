<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Dynamic Code Picker</title>
    <script src="https://www.contentstack.com/sdks/contentstack-ui-extensions/dist/latest/ui-extension-sdk.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 10px;
      }
      .search-wrapper {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px;
        min-height: 40px;
        cursor: text;
      }
      .search-wrapper input {
        border: none;
        outline: none;
        flex: 1;
        padding: 6px;
        min-width: 150px;
        font-size: 14px;
      }
      #chips-container {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 10px;
        min-height: 20px;
      }
      .tag {
        background: #eef6ff;
        border: 1px solid #3399ff;
        border-radius: 16px;
        padding: 4px 8px;
        display: inline-flex;
        align-items: center;
        font-size: 13px;
      }
      .remove {
        margin-left: 6px;
        cursor: pointer;
        color: red;
        font-weight: bold;
      }
      ul {
        list-style: none;
        padding: 0;
        margin-top: 4px;
        max-height: calc(3 * 34px);
        overflow-y: auto;
        border-radius: 4px;
        min-height: 0;
      }
      ul.has-results {
        border: 1px solid #ddd;
      }
      li {
        padding: 8px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }
      li:last-child {
        border-bottom: none;
      }
      li:hover {
        background: #f0f0f0;
      }
      .status-message {
        color: #d9534f;
        margin-top: 10px;
        white-space: pre-line;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
      tr.unavailable {
        background-color: #fff3f3;
      }
    </style>
  </head>

  <body>
    <div class="search-wrapper" id="search-wrapper">
      <input type="text" id="search" placeholder="Search..." />
    </div>

    <div id="chips-container"></div>
    <ul id="results"></ul>
    <div id="status-message" class="status-message"></div>
    <div id="selected-table"></div>

    <script>
      ContentstackUIExtension.init().then(async function (extension) {
        console.log("ðŸ§© Extension initialized:", extension);
        extension.window.updateHeight();

        const config = extension.field.schema.config || {};
        const extconfig = extension.config || {};
        const managementToken = extconfig.management_token || "";
        const apiUrl = config.api_url;
        const isProductField = extension.field.schema.display_name
          .toLowerCase()
          .includes("product");
        const categoryField = config.field_type || "";

        const todayUTC = new Date();
        const day = String(todayUTC.getUTCDate()).padStart(2, "0");
        const month = String(todayUTC.getUTCMonth() + 1).padStart(2, "0");
        const year = String(todayUTC.getUTCFullYear());
        const todayDate = `${day}${month}${year}`;
        const tokenWithDate = `${managementToken}${todayDate}`;
        const encodedAuth = btoa(tokenWithDate);

        const statusMessage = document.getElementById("status-message");
        const searchInput = document.getElementById("search");
        const resultsList = document.getElementById("results");
        const chipsContainer = document.getElementById("chips-container");
        const selectedTableDiv = document.getElementById("selected-table");
        const searchWrapper = document.getElementById("search-wrapper");

        if (!apiUrl) {
          statusMessage.innerText =
            "ðŸš¨ Configuration Error: 'api_url' is missing in field config.";
          extension.window.updateHeight();
          return;
        }

        function normalizeToArray(val) {
          if (!val) return [];
          if (Array.isArray(val)) return val;
          if (typeof val === "string") return [val];
          return [];
        }

        // ðŸ§© Restore saved field data (could be SKU array or object array)
        let savedFieldData = await extension.field.getData();
        let selectedValues = [];
        let latestProductsCache = [];

        if (Array.isArray(savedFieldData) && savedFieldData.length > 0) {
          if (typeof savedFieldData[0] === "object" && savedFieldData[0].sku) {
            latestProductsCache = savedFieldData;
            selectedValues = savedFieldData.map((p) => p.sku);
            console.log(
              "âœ… Restored full product data from field:",
              latestProductsCache
            );
          } else {
            selectedValues = savedFieldData;
            console.warn("âš ï¸ Found only SKU array in saved field data");
          }
        }

        // ðŸ§  Get selected location (unchanged)
        function getSelectedLocation() {
          try {
            const entryData =
              typeof extension.entry.getData === "function"
                ? extension.entry.getData() || {}
                : (extension.entry || {}).entry || {};
            if (
              entryData &&
              Object.prototype.hasOwnProperty.call(entryData, "location")
            ) {
              const arr = normalizeToArray(entryData.location);
              return arr.length > 0 ? arr : null;
            }
            return null;
          } catch (err) {
            console.error("âŒ Error in getSelectedLocation:", err);
            return null;
          }
        }

        function validateProductAvailability() {
          if (!isProductField || selectedValues.length === 0) {
            statusMessage.innerText = "";
            return;
          }

          const location = getSelectedLocation();
          if (!location || location.length === 0) {
            statusMessage.innerText = "";
            renderSelectedTable();
            return;
          }

          const selectedLocations = Array.isArray(location)
            ? location
            : [location];
          const unavailableProducts = [];

          selectedValues.forEach((sku) => {
            const product = latestProductsCache.find((p) => p.sku === sku);
            if (product) {
              const productLocations = Array.isArray(product.locations)
                ? product.locations
                : [];
              const unavailableAt = selectedLocations.filter(
                (loc) => !productLocations.includes(loc)
              );
              if (unavailableAt.length > 0) {
                unavailableProducts.push({ sku, unavailableAt });
              }
            }
          });

          if (unavailableProducts.length > 0) {
            const msgLines = unavailableProducts.map(
              (p) => `${p.sku} not available at selected locations`
            );
            statusMessage.innerText = msgLines.join("\n");
          } else {
            statusMessage.innerText = "";
          }

          renderSelectedTable();
        }

        async function renderSelectedTable() {
          selectedTableDiv.innerHTML = "";
          if (!isProductField || selectedValues.length === 0) return;

          const table = document.createElement("table");
          const header = document.createElement("tr");
          ["Order", "Product", "Not Available At", "Action"].forEach((h) => {
            const th = document.createElement("th");
            th.innerText = h;
            header.appendChild(th);
          });
          table.appendChild(header);

          const location = getSelectedLocation();
          const selectedLocations = Array.isArray(location)
            ? location
            : location
            ? [location]
            : [];

          selectedValues.forEach((sku, index) => {
            const row = document.createElement("tr");
            const orderCell = document.createElement("td");
            orderCell.innerText = index + 1;
            row.appendChild(orderCell);

            const productCell = document.createElement("td");
            productCell.innerText = sku;
            const product = latestProductsCache.find((p) => p.sku === sku);

            let unavailableAt = [];
            if (product) {
              const productLocations = Array.isArray(product.locations)
                ? product.locations
                : [];
              unavailableAt =
                selectedLocations.length > 0
                  ? selectedLocations.filter(
                      (loc) => !productLocations.includes(loc)
                    )
                  : [];
            }

            if (unavailableAt.length > 0) productCell.style.color = "red";
            row.appendChild(productCell);

            const notAvailableCell = document.createElement("td");
            notAvailableCell.innerText =
              unavailableAt.length > 0 ? unavailableAt.join(", ") : "";
            row.appendChild(notAvailableCell);

            const actionCell = document.createElement("td");
            const removeBtn = document.createElement("span");
            removeBtn.innerText = "Remove";
            removeBtn.style.cursor = "pointer";
            removeBtn.style.color = "red";
            removeBtn.onclick = async function () {
              selectedValues.splice(index, 1);
              latestProductsCache = latestProductsCache.filter(
                (p) => p.sku !== sku
              );
              await extension.field.setData(latestProductsCache);
              renderSelectedTable();
              validateProductAvailability();
            };
            actionCell.appendChild(removeBtn);
            row.appendChild(actionCell);
            table.appendChild(row);
          });

          selectedTableDiv.appendChild(table);
          extension.window.updateHeight();
        }

        function renderChips() {
          chipsContainer.innerHTML = "";
          if (isProductField) {
            renderSelectedTable();
            return;
          }

          selectedValues.forEach((code, index) => {
            const chip = document.createElement("div");
            chip.className = "tag";
            chip.innerText = code;
            const removeBtn = document.createElement("span");
            removeBtn.className = "remove";
            removeBtn.innerText = "Ã—";
            removeBtn.onclick = async function () {
              selectedValues.splice(index, 1);
              await extension.field.setData(selectedValues);
              renderChips();
            };
            chip.appendChild(removeBtn);
            chipsContainer.appendChild(chip);
          });
          extension.window.updateHeight();
        }

        function renderSearchResults(data) {
          resultsList.innerHTML = "";
          if (data.length > 0) resultsList.classList.add("has-results");
          else resultsList.classList.remove("has-results");

          data.forEach((item) => {
            let displayValue = "";
            if (isProductField) {
              displayValue = item.sku;
            } else if (categoryField.toLowerCase() === "category") {
              displayValue = item.name; // show category name
            } else {
              displayValue = item.code; // default for other types
            }

            const li = document.createElement("li");
            li.innerText = displayValue;

            li.onclick = async function () {
              const value = isProductField ? item.sku : item.code;
              if (!selectedValues.includes(value)) {
                selectedValues.push(value);

                if (isProductField) {
                  latestProductsCache.push(item);
                  await extension.field.setData(latestProductsCache);
                  renderSelectedTable();
                  validateProductAvailability();
                } else {
                  await extension.field.setData(selectedValues);
                  renderChips();
                }
              }
              searchInput.value = "";
              resultsList.innerHTML = "";
              resultsList.classList.remove("has-results");
            };

            resultsList.appendChild(li);
          });
          extension.window.updateHeight();
        }

        searchInput.addEventListener("input", function () {
          const query = searchInput.value.toLowerCase();
          resultsList.innerHTML = "";
          statusMessage.innerText = "";
          resultsList.classList.remove("has-results");
          if (!query) return;

          const paramName = isProductField ? "sku" : "code";
          const fullUrl = `${apiUrl}?${paramName}=${encodeURIComponent(
            query
          )}&currentPage=1&perPage=10`;

          fetch(fullUrl, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: `${encodedAuth}`,
            },
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.success && Array.isArray(data.data)) {
                renderSearchResults(data.data);
                statusMessage.innerText = ""; // clear previous errors
              } else {
                const apiErrorMsg =
                  data?.error?.message ||
                  data?.message ||
                  "Something went wrong while fetching data.";
                statusMessage.innerText = `${apiErrorMsg}`;
                renderSearchResults([]);
              }
            })
            .catch((error) => {
              console.error("âŒ API Error:", error);
              statusMessage.innerText = `âŒ ${
                error.message || "Network error occurred."
              }`;
              renderSearchResults([]);
            });
        });

        renderChips();
        renderSelectedTable();
        validateProductAvailability();

        if (isProductField) {
          extension.entry.onChange(() => {
            validateProductAvailability();
          });
        }

        searchWrapper.addEventListener("click", () => searchInput.focus());
        extension.field.onValueChanged(function (newValue) {
          if (Array.isArray(newValue) && newValue.length > 0) {
            if (typeof newValue[0] === "object" && newValue[0].sku) {
              latestProductsCache = newValue;
              selectedValues = newValue.map((p) => p.sku);
            } else {
              selectedValues = newValue;
            }
          } else {
            selectedValues = [];
            latestProductsCache = [];
          }
          renderChips();
        });
      });
    </script>
  </body>
</html>
